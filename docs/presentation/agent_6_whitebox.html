
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Agent 6: KAG (MemGPT) - Deep Dive Whitebox</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;     /* Slate 900 */
            --accent: #3b82f6;      /* Blue 500 */
            --success: #10b981;     /* Emerald 500 */
            --warning: #f59e0b;     /* Amber 500 */
            --danger: #ef4444;      /* Red 500 */
            --bg: #f8fafc;
            --code-bg: #1e293b;
            --code-text: #e2e8f0;
        }
        
        body { font-family: 'Inter', sans-serif; padding: 40px; background: var(--bg); color: #334155; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 40px; border-top: 6px solid var(--accent); }
        .header h1 { margin: 0; color: var(--primary); font-size: 2.8em; letter-spacing: -0.02em; }
        .role-title { font-size: 1.4em; color: #64748b; margin-top: 10px; font-weight: 500; }
        
        .badges { margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap; }
        .badge { padding: 6px 14px; border-radius: 24px; font-weight: 600; font-size: 0.9em; }
        .badge-science { background: #eff6ff; color: var(--accent); border: 1px solid #bfdbfe; }
        .badge-tech { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; }
        
        /* Diagram */
        .card { background: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .key-insight { 
            margin-top: 20px; padding: 20px; 
            border-left: 4px solid var(--warning); 
            background: #fffbeb; color: #92400e;
            font-size: 1.1em;
        }
        
        /* Phase Steps */
        .phase-section h2 { color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 0; }
        
        .step { margin-bottom: 40px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .step-header { 
            padding: 15px 25px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .step-title { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .method-code { font-family: 'Fira Code', monospace; background: #e2e8f0; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.9em; }
        
        .step-body { padding: 25px; }
        .step-desc { font-size: 1.05em; margin-bottom: 20px; color: #1e293b; }
        
        /* IO Grid */
        .io-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .io-box { padding: 15px; border-radius: 8px; font-size: 0.95em; }
        .io-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.05em; }
        
        .io-input { background: #f1f5f9; border: 1px solid #cbd5e1; }
        .io-mech { background: #eef2ff; border: 1px solid #c7d2fe; }
        .io-output { background: #f0fdf4; border: 1px solid #bbf7d0; }
        
        /* Deep Dive collapsible */
        details.deep-dive { margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 8px; }
        details.deep-dive summary { 
            padding: 12px 20px; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--accent);
            list-style: none; display: flex; align-items: center; gap: 8px;
        }
        details.deep-dive summary::before { content: "‚öôÔ∏è"; }
        details.deep-dive[open] summary { border-bottom: 1px solid #e2e8f0; }
        
        .dive-content { padding: 20px; background: #ffffff; }
        
        pre { margin: 0; background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; color: var(--code-text); font-size: 0.9em; }
        
        .formula-box { 
            background: #fff; border-left: 4px solid var(--secondary); padding: 15px; margin: 15px 0; font-family: 'Times New Roman', serif; font-style: italic; font-size: 1.1em; 
        }

        /* Complexity Card */
        .complexity-card { background: #1e293b; color: white; padding: 30px; border-radius: 16px; margin-top: 40px; }
        .complexity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-top: 20px; }
        .metric { text-align: center; }
        .metric-val { font-size: 2em; font-weight: 700; color: var(--accent); }
        .metric-label { font-size: 0.9em; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Detail Panel */
        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 90; }
        .backdrop.active { opacity: 1; pointer-events: all; }
        
        .detail-panel { 
            position: fixed; top: 0; right: -500px; width: 450px; height: 100%; 
            background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 100; overflow-y: auto;
        }
        .detail-panel.active { right: 0; }
        
        .panel-header { background: var(--primary); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { margin: 0; font-size: 1.3em; }
        
        .panel-body { padding: 25px; }
        .panel-section { margin-bottom: 25px; font-size: 1em; color: #475569; }
        .panel-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.05em; }
        .panel-code { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: 'Fira Code', monospace; font-size: 0.85em; color: var(--primary); white-space: pre-wrap; }

    </style>
</head>
<body>
    <div class="container">
        
        <div class="header">
            <div style="text-transform: uppercase; color: var(--accent); font-weight: 700; font-size: 0.9em; letter-spacing: 0.1em; margin-bottom: 10px;">Detailed Technical Specification</div>
            <h1>Agent 6: KAG (MemGPT)</h1>
            <div class="role-title">Personal OS (H·ªá ƒëi·ªÅu h√†nh c√° nh√¢n)</div>
            
            <p style="font-size: 1.1em; max-width: 800px; margin-top: 20px;">Gi·∫£i quy·∫øt gi·ªõi h·∫°n Context Window c·ªßa LLM trong c√°c l·ªô tr√¨nh h·ªçc k√©o d√†i h√†ng tu·∫ßn/th√°ng b·∫±ng c∆° ch·∫ø b·ªô nh·ªõ ph√¢n t·∫ßng.</p>
            
            <div class="badges">
                <span class="badge badge-science">MemGPT</span><span class="badge badge-science">Zettelkasten</span><span class="badge badge-science">Dual-Code Theory</span>
                <span class="badge badge-tech">Neo4j Archival</span><span class="badge badge-tech">Redis WorkingMem</span><span class="badge badge-tech">Mermaid Gen</span>
            </div>
        </div>

        <div class="card">
            <h2>Process Architecture</h2>
            <div class="mermaid">

sequenceDiagram
    participant User
    participant A6 as Agent 6 (OS)
    participant RAM as Working Context
    participant Disk as Neo4j Graph
    
    User->>A6: "Recall lesson from last week"
    
    loop Heartbeat
        A6->>RAM: Check Pressure
        opt Pressure > 70% (Overflow Warning)
            A6->>A6: Summarize Oldest Turns
            A6->>Disk: Archive (Zettelkasten Note)
            A6->>RAM: Evict Raw Tokens
        end
        
        A6->>A6: Retrieval Function Call
        A6->>Disk: Search(Query)
        Disk-->>A6: Retrievals
    end
    
    A6-->>User: Synthisized Answer

    click User showDetails
    click A6 showDetails
    click RAM showDetails
    click Disk showDetails
        
click User showDetails
click A6 showDetails
click RAM showDetails
click Disk showDetails
            </div>
            <div class="key-insight">
                <strong>üí° Core Deviation / Innovation:</strong> C∆° ch·∫ø 'Memory Pressure': T·ª± ƒë·ªông t√≠nh to√°n √°p l·ª±c b·ªô nh·ªõ. Khi v∆∞·ª£t ng∆∞·ª°ng 70%, k√≠ch ho·∫°t quy tr√¨nh Auto-Archive ƒë·ªÉ t√≥m t·∫Øt v√† c·∫•t gi·ªØ ki·∫øn th·ª©c c≈© v√†o Graph (Zettelkasten).
            </div>
        </div>

        
            <div class="phase-section">
                <h2>Phase 1: Memory Management</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Pressure Monitor</span>
                        <span class="method-code">is_pressure_high()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">T√≠nh to√°n t·ª∑ l·ªá token s·ª≠ d·ª•ng so v·ªõi gi·ªõi h·∫°n c·ª≠a s·ªï.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                TokenCount
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Thresholding
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Boolean (IsOverflow)
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: Pressure Formula</summary>
                        <div class="dive-content">
                            <pre><code># Memory Pressure Calculation
current_tokens = count_tokens(system_prompt + conversation_history)
max_tokens = 8192 (Gemini 1.5 Flash Window Safe Limit)

pressure_ratio = current_tokens / max_tokens

IF pressure_ratio > 0.7:
    TRIGGER Auto-Archival
ELSE:
    CONTINUE</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
            <div class="phase-section">
                <h2>Phase 2: Knowledge Artifacts</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Note Generation (Dual-Code)</span>
                        <span class="method-code">_generate_artifact()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">T·∫°o ghi ch√∫ Zettelkasten (Text) + Bi·ªÉu ƒë·ªì t∆∞ duy (Visual) c√πng l√∫c.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                Context
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Multi-modal Output
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Markdown + Mermaid
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: Dual-Code Prompt</summary>
                        <div class="dive-content">
                            <pre><code>Task: Create a Zettelkasten Note (Atomic).
Requirement: Apply Dual-Code Theory (Paivio).

Output Format:
# [Concept Name]
[Concise textual explanation...]

## Visual Map
```mermaid
graph TD
   ... (Visual representation of concept)
```

Tags: #tag1 #tag2</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
        
        <div class="complexity-card">
            <h2>Complexity & Performance Analysis</h2>
            <div class="complexity-grid">
                
            <div class="metric">
                <div class="metric-val">8192</div>
                <div class="metric-label">Window (tokens)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">0.7</div>
                <div class="metric-label">Threshold (ratio)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">5</div>
                <div class="metric-label">Heartbeats (max)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">O(N)</div>
                <div class="metric-label">Archive (ops)</div>
            </div>
        
            </div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;">
                <h3>Performance Bottleneck</h3>
                <p>Recursive Function Calling loop (Heartbeat) can stall if not capped.</p>
            </div>
        </div>

        <div style="text-align: center; color: #94a3b8; margin-top: 60px; font-size: 0.9em;">
             Thesis Defense System ‚Ä¢ Generated by Antigravity ‚Ä¢ 2026-01-15 21:02
        </div>
    </div>

    <!-- Detail Panel -->
    <div id="backdrop" class="backdrop" onclick="closeDetails()"></div>
    <div id="detail-panel" class="detail-panel">
        <div class="panel-header">
            <h2 id="panel-title">Component Details</h2>
            <button onclick="closeDetails()" style="background:none; border:none; color:white; font-size:1.5em; cursor:pointer;">√ó</button>
        </div>
        <div class="panel-body">
            <div id="panel-desc" class="panel-section"></div>
            
            <div class="panel-section" style="display:none; background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 25px;">
                <div class="panel-label" style="color: var(--accent);">Internal Logic</div>
                <div id="panel-logic" style="color: #334155; font-size: 0.95em;"></div>
            </div>

            <div class="panel-label">Technical Specs</div>
            <pre id="panel-specs" class="panel-code"></pre>
            
            <div class="panel-label">Source Reference</div>
            <div id="panel-source" style="font-family: 'Fira Code', monospace; color: var(--accent); font-size: 0.9em;"></div>
        </div>
    </div>

    <script>
        const NODE_DETAILS = {"User": {"title": "User Request", "desc": "The learner's input or query.", "logic": "Initiates the session.", "specs": "Type: String", "source": "Frontend"}, "A6": {"title": "KAG Agent (OS Kernel)", "desc": "Orchestrates the Memory OS and Heartbeat Loop during thinking process.", "logic": "1. Monitor Pressure.\n2. Compile Context.\n3. Think (LLM).\n4. Act (Tools).\n5. Loop.", "specs": "Model: Gemini 1.5 Flash\nMax Steps: 5", "source": "backend/agents/kag_agent.py"}, "RAM": {"title": "Working Context (RAM)", "desc": "Short-term memory including System Prompt, Core Memory, and FIFO Queue.", "logic": "Managed by `WorkingMemory` class. Maintains fixed token window.", "specs": "Limit: 8192 tokens\nEviction: FIFO", "source": "backend/memory/working_memory.py"}, "Disk": {"title": "Archival Memory (Disk)", "desc": "Long-term storage in Neo4j (Graph + Vector).", "logic": "Stores Zettelkasten notes and raw summaries.\nSupports Vector Search & Cypher Queries.", "specs": "Storage: Neo4j\nIndex: Vector", "source": "backend/memory/archival_storage.py"}};

        function showDetails(nodeId) {
            const data = NODE_DETAILS[nodeId];
            if (!data) return;

            document.getElementById('panel-title').innerText = data.title;
            document.getElementById('panel-desc').innerHTML = data.desc;
            
            // Logic Section (New)
            const logicEl = document.getElementById('panel-logic');
            if (data.logic) {
                logicEl.innerText = data.logic;
                logicEl.parentElement.style.display = 'block';
            } else {
                logicEl.parentElement.style.display = 'none';
            }

            document.getElementById('panel-specs').innerText = data.specs || "No specific configuration.";
            document.getElementById('panel-source').innerText = data.source || "System Component";
            
            document.getElementById('backdrop').classList.add('active');
            document.getElementById('detail-panel').classList.add('active');
        }

        function closeDetails() {
            document.getElementById('backdrop').classList.remove('active');
            document.getElementById('detail-panel').classList.remove('active');
        }

        // Auto-attach clicks after Mermaid renders
        // Note: We use the native mermaid click directive in the graph definition
    </script>
</body>
</html>
