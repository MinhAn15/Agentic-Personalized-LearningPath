
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Agent 4: Tutor - Deep Dive Whitebox</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;     /* Slate 900 */
            --accent: #3b82f6;      /* Blue 500 */
            --success: #10b981;     /* Emerald 500 */
            --warning: #f59e0b;     /* Amber 500 */
            --danger: #ef4444;      /* Red 500 */
            --bg: #f8fafc;
            --code-bg: #1e293b;
            --code-text: #e2e8f0;
        }
        
        body { font-family: 'Inter', sans-serif; padding: 40px; background: var(--bg); color: #334155; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 40px; border-top: 6px solid var(--accent); }
        .header h1 { margin: 0; color: var(--primary); font-size: 2.8em; letter-spacing: -0.02em; }
        .role-title { font-size: 1.4em; color: #64748b; margin-top: 10px; font-weight: 500; }
        
        .badges { margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap; }
        .badge { padding: 6px 14px; border-radius: 24px; font-weight: 600; font-size: 0.9em; }
        .badge-science { background: #eff6ff; color: var(--accent); border: 1px solid #bfdbfe; }
        .badge-tech { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; }
        
        /* Diagram */
        .card { background: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .key-insight { 
            margin-top: 20px; padding: 20px; 
            border-left: 4px solid var(--warning); 
            background: #fffbeb; color: #92400e;
            font-size: 1.1em;
        }
        
        /* Phase Steps */
        .phase-section h2 { color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 0; }
        
        .step { margin-bottom: 40px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .step-header { 
            padding: 15px 25px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .step-title { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .method-code { font-family: 'Fira Code', monospace; background: #e2e8f0; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.9em; }
        
        .step-body { padding: 25px; }
        .step-desc { font-size: 1.05em; margin-bottom: 20px; color: #1e293b; }
        
        /* IO Grid */
        .io-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .io-box { padding: 15px; border-radius: 8px; font-size: 0.95em; }
        .io-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.05em; }
        
        .io-input { background: #f1f5f9; border: 1px solid #cbd5e1; }
        .io-mech { background: #eef2ff; border: 1px solid #c7d2fe; }
        .io-output { background: #f0fdf4; border: 1px solid #bbf7d0; }
        
        /* Deep Dive collapsible */
        details.deep-dive { margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 8px; }
        details.deep-dive summary { 
            padding: 12px 20px; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--accent);
            list-style: none; display: flex; align-items: center; gap: 8px;
        }
        details.deep-dive summary::before { content: "‚öôÔ∏è"; }
        details.deep-dive[open] summary { border-bottom: 1px solid #e2e8f0; }
        
        .dive-content { padding: 20px; background: #ffffff; }
        
        pre { margin: 0; background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; color: var(--code-text); font-size: 0.9em; }
        
        .formula-box { 
            background: #fff; border-left: 4px solid var(--secondary); padding: 15px; margin: 15px 0; font-family: 'Times New Roman', serif; font-style: italic; font-size: 1.1em; 
        }

        /* Complexity Card */
        .complexity-card { background: #1e293b; color: white; padding: 30px; border-radius: 16px; margin-top: 40px; }
        .complexity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-top: 20px; }
        .metric { text-align: center; }
        .metric-val { font-size: 2em; font-weight: 700; color: var(--accent); }
        .metric-label { font-size: 0.9em; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Detail Panel */
        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 90; }
        .backdrop.active { opacity: 1; pointer-events: all; }
        
        .detail-panel { 
            position: fixed; top: 0; right: -500px; width: 450px; height: 100%; 
            background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 100; overflow-y: auto;
        }
        .detail-panel.active { right: 0; }
        
        .panel-header { background: var(--primary); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { margin: 0; font-size: 1.3em; }
        
        .panel-body { padding: 25px; }
        .panel-section { margin-bottom: 25px; font-size: 1em; color: #475569; }
        .panel-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.05em; }
        .panel-code { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: 'Fira Code', monospace; font-size: 0.85em; color: var(--primary); white-space: pre-wrap; }

    </style>
</head>
<body>
    <div class="container">
        
        <div class="header">
            <div style="text-transform: uppercase; color: var(--accent); font-weight: 700; font-size: 0.9em; letter-spacing: 0.1em; margin-bottom: 10px;">Detailed Technical Specification</div>
            <h1>Agent 4: Tutor</h1>
            <div class="role-title">The Socratic Guide (Gia s∆∞ Socratic)</div>
            
            <p style="font-size: 1.1em; max-width: 800px; margin-top: 20px;">NgƒÉn ch·∫∑n vi·ªác h·ªçc v·∫πt (passive learning) b·∫±ng c√°ch kh√¥ng bao gi·ªù ƒë∆∞a ra ƒë√°p √°n tr·ª±c ti·∫øp, m√† s·ª≠ d·ª•ng g·ª£i √Ω t√≠ch c·ª±c (scaffolding).</p>
            
            <div class="badges">
                <span class="badge badge-science">Dynamic CoT</span><span class="badge badge-science">Scaffolding Theory</span><span class="badge badge-science">Harvard 7 Principles</span>
                <span class="badge badge-tech">Gemini 1.5</span><span class="badge badge-tech">Regex Guards</span><span class="badge badge-tech">Vector Retrieval</span>
            </div>
        </div>

        <div class="card">
            <h2>Process Architecture</h2>
            <div class="mermaid">

sequenceDiagram
    participant User
    participant A4 as Agent 4
    
    User->>A4: "I'm stuck on this SQL error"
    
    box rgb(240, 240, 240) Internal "Sub-conscious"
        A4->>A4: Retrieve Context (RAG)
        A4->>A4: Generate CoT Trace (The Solution)
        A4->>A4: Slicing: Break Solution into 5 Steps
    end
    
    loop Scaffolding
        A4->>A4: Leakage Check (Regex)
        A4-->>User: Hint 1 (Broad Concept)
        User->>A4: Still stuck
        A4-->>User: Hint 2 (Specific Syntax)
    end

    click User showDetails
    click A4 showDetails
    click RAG showDetails
    click KG showDetails
    click Personal showDetails
    click CoT showDetails
    click Scaffold showDetails
        
click User showDetails
click A4 showDetails
click RAG showDetails
click KG showDetails
click Personal showDetails
click CoT showDetails
click Scaffold showDetails
            </div>
            <div class="key-insight">
                <strong>üí° Core Deviation / Innovation:</strong> S·ª≠ d·ª•ng 'Hidden Chain-of-Thought': Agent gi·∫£i b√†i to√°n ng·∫ßm b√™n trong (CoT) ƒë·ªÉ hi·ªÉu s√¢u v·∫•n ƒë·ªÅ, nh∆∞ng ch·ªâ xu·∫•t ra c√°c g·ª£i √Ω t·ª´ng b∆∞·ªõc (Scaffolding) cho ng∆∞·ªùi h·ªçc.
            </div>
        </div>

        
            <div class="phase-section">
                <h2>Phase 1: Hidden Reasoning</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Generate Hidden CoT</span>
                        <span class="method-code">_generate_cot_traces()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">Sinh chu·ªói suy lu·∫≠n ƒë·∫ßy ƒë·ªß ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ c·ªßa h·ªçc sinh.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                Problem + Context
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Self-Consistency CoT
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Solution Trace
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: CoT Prompt Template</summary>
                        <div class="dive-content">
                            <pre><code>INSTRUCTION: You are a tutor. Solve this problem step-by-step.
IMPORTANT: Enclose your reasoning in <thinking> tags.

Problem: {student_question}

Response:
<thinking>
1. The user is asking about 'Group By'.
2. The error is likely omitting the non-aggregated column.
3. Solution: Add the column to the GROUP BY clause.
</thinking>
...</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
            <div class="phase-section">
                <h2>Phase 2: Pedagogical Guardrails</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Leakage Guard</span>
                        <span class="method-code">_extract_scaffold()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">ƒê·∫£m b·∫£o kh√¥ng ti·∫øt l·ªô code ƒë√°p √°n trong l·ªùi gi·∫£i th√≠ch.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                Draft Response
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Regex Pattern Matching
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Safe Response or Fallback
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: Guard Patterns</summary>
                        <div class="dive-content">
                            <pre><code>Patterns = [
  r"```sql.*```",          # No code blocks
  r"(SELECT|FROM|WHERE).*", # No raw SQL segments
  r"Answer is .*",          # No direct answers
]

If match found:
   Rewrite response to be more abstract.</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
        
        <div class="complexity-card">
            <h2>Complexity & Performance Analysis</h2>
            <div class="complexity-grid">
                
            <div class="metric">
                <div class="metric-val">~2k</div>
                <div class="metric-label">Prompt Size (tokens)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">15+</div>
                <div class="metric-label">Safety Checks (rules)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">n=3</div>
                <div class="metric-label">Reasoning (CoT)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">2-3</div>
                <div class="metric-label">Latency (sec)</div>
            </div>
        
            </div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;">
                <h3>Performance Bottleneck</h3>
                <p>Text generation Speed. Mitigated by streaming responses (future).</p>
            </div>
        </div>

        <div style="text-align: center; color: #94a3b8; margin-top: 60px; font-size: 0.9em;">
             Thesis Defense System ‚Ä¢ Generated by Antigravity ‚Ä¢ 2026-01-14 18:01
        </div>
    </div>

    <!-- Detail Panel -->
    <div id="backdrop" class="backdrop" onclick="closeDetails()"></div>
    <div id="detail-panel" class="detail-panel">
        <div class="panel-header">
            <h2 id="panel-title">Component Details</h2>
            <button onclick="closeDetails()" style="background:none; border:none; color:white; font-size:1.5em; cursor:pointer;">√ó</button>
        </div>
        <div class="panel-body">
            <div id="panel-desc" class="panel-section"></div>
            
            <div class="panel-section" style="display:none; background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 25px;">
                <div class="panel-label" style="color: var(--accent);">Internal Logic</div>
                <div id="panel-logic" style="color: #334155; font-size: 0.95em;"></div>
            </div>

            <div class="panel-label">Technical Specs</div>
            <pre id="panel-specs" class="panel-code"></pre>
            
            <div class="panel-label">Source Reference</div>
            <div id="panel-source" style="font-family: 'Fira Code', monospace; color: var(--accent); font-size: 0.9em;"></div>
        </div>
    </div>

    <script>
        const NODE_DETAILS = {"User": {"title": "Learner Actor", "desc": "End-user asking for help via Chat.", "logic": "1. Asks question.\n2. Receives Socratic guidance (not answers).", "specs": "Input: Natural Language", "source": "Frontend"}, "A4": {"title": "TutorAgent", "desc": "Socratic Guide enforcing Harvard 7 Principles.", "logic": "1. Receive Question.\n2. Determine Phase (Intro/Probing/Scaffold).\n3. Grounding (3-Layer).\n4. Generate Response.", "specs": "Model: Gemini 1.5\nEnforcer: Harvard7Enforcer", "source": "backend/agents/tutor_agent.py"}, "RAG": {"title": "Doc Grounding (Layer 1)", "desc": "Retrieves context from ChromaDB (PDFs/Slides).", "logic": "Query Vector Store -> Top-k Chunks -> Context Window.", "specs": "Source: ChromaDB\nEmbedding: Gemini-001", "source": "backend/agents/tutor_agent.py"}, "KG": {"title": "Course Grounding (Layer 2)", "desc": "Retrieves structured concepts from Neo4j.", "logic": "Cypher Query -> Concept + Prereqs + Misconceptions.", "specs": "Source: Neo4j", "source": "backend/agents/tutor_agent.py"}, "Personal": {"title": "Personal Grounding (Layer 3)", "desc": "Retrieves learner's past mastery and errors.", "logic": "Cypher Query -> Learner Node -> History/Notes.", "specs": "Source: Neo4j (LearnerProfile)", "source": "backend/agents/tutor_agent.py"}, "CoT": {"title": "Dynamic Chain-of-Thought", "desc": "Generates internal reasoning traces (Hidden Manual).", "logic": "1. Prompt with Exemplars (Wei 2022).\n2. Generate n=3 traces.\n3. Self-Consistency Check.", "specs": "Traces: 3\nMethod: `_generate_cot_traces`", "source": "backend/agents/tutor_agent.py"}, "Scaffold": {"title": "Scaffolding Slicer", "desc": "Breaks the solution into small, digestible hints.", "logic": "1. Take Best Trace.\n2. Slice into steps.\n3. Regex Guard (Leakage Check).\n4. Deliver one by one.", "specs": "Max Steps: 5\nGuard: Regex", "source": "backend/agents/tutor_agent.py"}};

        function showDetails(nodeId) {
            const data = NODE_DETAILS[nodeId];
            if (!data) return;

            document.getElementById('panel-title').innerText = data.title;
            document.getElementById('panel-desc').innerHTML = data.desc;
            
            // Logic Section (New)
            const logicEl = document.getElementById('panel-logic');
            if (data.logic) {
                logicEl.innerText = data.logic;
                logicEl.parentElement.style.display = 'block';
            } else {
                logicEl.parentElement.style.display = 'none';
            }

            document.getElementById('panel-specs').innerText = data.specs || "No specific configuration.";
            document.getElementById('panel-source').innerText = data.source || "System Component";
            
            document.getElementById('backdrop').classList.add('active');
            document.getElementById('detail-panel').classList.add('active');
        }

        function closeDetails() {
            document.getElementById('backdrop').classList.remove('active');
            document.getElementById('detail-panel').classList.remove('active');
        }

        // Auto-attach clicks after Mermaid renders
        // Note: We use the native mermaid click directive in the graph definition
    </script>
</body>
</html>
