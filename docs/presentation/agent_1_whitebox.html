
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Agent 1: Knowledge Extraction - Deep Dive Whitebox</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;     /* Slate 900 */
            --accent: #3b82f6;      /* Blue 500 */
            --success: #10b981;     /* Emerald 500 */
            --warning: #f59e0b;     /* Amber 500 */
            --danger: #ef4444;      /* Red 500 */
            --bg: #f8fafc;
            --code-bg: #1e293b;
            --code-text: #e2e8f0;
        }
        
        body { font-family: 'Inter', sans-serif; padding: 40px; background: var(--bg); color: #334155; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 40px; border-top: 6px solid var(--accent); }
        .header h1 { margin: 0; color: var(--primary); font-size: 2.8em; letter-spacing: -0.02em; }
        .role-title { font-size: 1.4em; color: #64748b; margin-top: 10px; font-weight: 500; }
        
        .badges { margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap; }
        .badge { padding: 6px 14px; border-radius: 24px; font-weight: 600; font-size: 0.9em; }
        .badge-science { background: #eff6ff; color: var(--accent); border: 1px solid #bfdbfe; }
        .badge-tech { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; }
        
        /* Diagram */
        .card { background: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .key-insight { 
            margin-top: 20px; padding: 20px; 
            border-left: 4px solid var(--warning); 
            background: #fffbeb; color: #92400e;
            font-size: 1.1em;
        }
        
        /* Phase Steps */
        .phase-section h2 { color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 0; }
        
        .step { margin-bottom: 40px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .step-header { 
            padding: 15px 25px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .step-title { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .method-code { font-family: 'Fira Code', monospace; background: #e2e8f0; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.9em; }
        
        .step-body { padding: 25px; }
        .step-desc { font-size: 1.05em; margin-bottom: 20px; color: #1e293b; }
        
        /* IO Grid */
        .io-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .io-box { padding: 15px; border-radius: 8px; font-size: 0.95em; }
        .io-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.05em; }
        
        .io-input { background: #f1f5f9; border: 1px solid #cbd5e1; }
        .io-mech { background: #eef2ff; border: 1px solid #c7d2fe; }
        .io-output { background: #f0fdf4; border: 1px solid #bbf7d0; }
        
        /* Deep Dive collapsible */
        details.deep-dive { margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 8px; }
        details.deep-dive summary { 
            padding: 12px 20px; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--accent);
            list-style: none; display: flex; align-items: center; gap: 8px;
        }
        details.deep-dive summary::before { content: "‚öôÔ∏è"; }
        details.deep-dive[open] summary { border-bottom: 1px solid #e2e8f0; }
        
        .dive-content { padding: 20px; background: #ffffff; }
        
        pre { margin: 0; background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; color: var(--code-text); font-size: 0.9em; }
        
        .formula-box { 
            background: #fff; border-left: 4px solid var(--secondary); padding: 15px; margin: 15px 0; font-family: 'Times New Roman', serif; font-style: italic; font-size: 1.1em; 
        }

        /* Complexity Card */
        .complexity-card { background: #1e293b; color: white; padding: 30px; border-radius: 16px; margin-top: 40px; }
        .complexity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-top: 20px; }
        .metric { text-align: center; }
        .metric-val { font-size: 2em; font-weight: 700; color: var(--accent); }
        .metric-label { font-size: 0.9em; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Detail Panel */
        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 90; }
        .backdrop.active { opacity: 1; pointer-events: all; }
        
        .detail-panel { 
            position: fixed; top: 0; right: -500px; width: 450px; height: 100%; 
            background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 100; overflow-y: auto;
        }
        .detail-panel.active { right: 0; }
        
        .panel-header { background: var(--primary); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { margin: 0; font-size: 1.3em; }
        
        .panel-body { padding: 25px; }
        .panel-section { margin-bottom: 25px; font-size: 1em; color: #475569; }
        .panel-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.05em; }
        .panel-code { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: 'Fira Code', monospace; font-size: 0.85em; color: var(--primary); white-space: pre-wrap; }

    </style>
</head>
<body>
    <div class="container">
        
        <div class="header">
            <div style="text-transform: uppercase; color: var(--accent); font-weight: 700; font-size: 0.9em; letter-spacing: 0.1em; margin-bottom: 10px;">Detailed Technical Specification</div>
            <h1>Agent 1: Knowledge Extraction</h1>
            <div class="role-title">The Librarian (Th·ªß th∆∞)</div>
            
            <p style="font-size: 1.1em; max-width: 800px; margin-top: 20px;">Chuy·ªÉn ƒë·ªïi t√†i li·ªáu phi c·∫•u tr√∫c th√†nh Knowledge Graph 3 l·ªõp (Concept-Relationship-Metadata) ƒë·ªÉ kh·∫Øc ph·ª•c ƒëi·ªÉm y·∫øu m·∫•t ng·ªØ c·∫£nh c·ªßa RAG truy·ªÅn th·ªëng.</p>
            
            <div class="badges">
                <span class="badge badge-science">LightRAG (Guo 2024)</span><span class="badge badge-science">MultiDocFusion (2025)</span><span class="badge badge-science">Dual-Graph Adaptation</span>
                <span class="badge badge-tech">Neo4j</span><span class="badge badge-tech">Gemini 1.5</span><span class="badge badge-tech">Redis Semaphores</span><span class="badge badge-tech">AsyncIO</span>
            </div>
        </div>

        <div class="card">
            <h2>Process Architecture</h2>
            <div class="mermaid">

graph TD
    subgraph P1[Phase 1: Ingestion]
        Doc[PDF Document] -->|Hash SHA256| Registry{Exists in Redis?}
        Registry -- No --> Chunk[MultiDocFusion Chunking]
    end
    
    subgraph P2[Phase 2: Parallel Extraction]
        Chunk -->|Semaphore=5| LLM[Gemini 1.5]
        LLM -->|Layer 1| Concepts[Concepts w/ Global Theme]
        LLM -->|Layer 2| Rels[Relationships w/ Edge Keywords]
        LLM -->|Layer 3| Meta[Metadata & Bloom Level]
    end
    
    subgraph P3[Phase 3: Resolution]
        Concepts --> ER[3-Way Entity Resolution]
        ER -->|Merge| UniqueNodes
    end
    
    subgraph P4[Phase 4: Persistence]
        UniqueNodes --> Neo4j[(Neo4j Graph)]
    end
    
    click Doc showDetails
    click Registry showDetails
    click Chunk showDetails
    click LLM showDetails
    click Concepts showDetails
    click Rels showDetails
    click Meta showDetails
    click ER showDetails
    click UniqueNodes showDetails
    click Neo4j showDetails
        
click Doc showDetails
click Registry showDetails
click Chunk showDetails
click LLM showDetails
click Concepts showDetails
click Rels showDetails
click Meta showDetails
click ER showDetails
click UniqueNodes showDetails
click Neo4j showDetails
            </div>
            <div class="key-insight">
                <strong>üí° Core Deviation / Innovation:</strong> S·ª≠ d·ª•ng 'Global Theme Injection' ƒë·ªÉ ƒë·ªãnh h∆∞·ªõng tr√≠ch xu·∫•t ngay t·ª´ b∆∞·ªõc chunking, v√† thu·∫≠t to√°n 3-Way Similarity (Semantic+Structural+Lexical) ƒë·ªÉ gi·∫£i quy·∫øt xung ƒë·ªôt th·ª±c th·ªÉ.
            </div>
        </div>

        
            <div class="phase-section">
                <h2>Phase 1: Semantic Chunking</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Multi-Document Fusion</span>
                        <span class="method-code">_multidocfusion_pipeline()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">Ph√¢n r√£ t√†i li·ªáu gi·ªØ l·∫°i c·∫•u tr√∫c ph√¢n c·∫•p (Header heirarchy) s·ª≠ d·ª•ng Pipeline 4 b∆∞·ªõc: Paragraph Split -> DSHP-LLM Tree -> DFS Grouping -> Refiner.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                Raw Document Stream
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Hierarchical Recursive Splitter
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Rich Chunks (Text + Path Context)
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: Algorithm Logic (MultiDocFusion)</summary>
                        <div class="dive-content">
                            <pre><code>async def _multidocfusion_pipeline(document):
    # Stage 1: Pre-split by paragraphs
    paragraphs = _paragraph_split(document)
    
    # Stage 2: DSHP-LLM - Build Hierarchical Tree
    tree = await _dshp_llm_build_tree(paragraphs)
    
    # Stage 3: DFS Grouping (Tree Traversal)
    grouped_sections = _dfs_group_tree(tree, paragraphs)
    
    # Stage 4: Refiner (Self-Correction)
    refined = await _refiner_phase(grouped_sections)
    
    return refined
# Implementation: backend/utils/semantic_chunker.py</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
            <div class="phase-section">
                <h2>Phase 2: 3-Layer Extraction</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Global Theme Injection</span>
                        <span class="method-code">_extract_concepts_from_chunk()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">Tr√≠ch xu·∫•t kh√°i ni·ªám nh∆∞ng b·∫Øt bu·ªôc LLM nh√¨n qua lƒÉng k√≠nh c·ªßa Domain (ch·ªß ƒë·ªÅ to√†n c·ª•c).</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                Chunk + Domain (e.g., 'SQL')
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Prompt Engineering (Global Context)
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                List[ConceptNode]
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: Prompt Template</summary>
                        <div class="dive-content">
                            <pre><code>SYSTEM: You are an expert Knowledge Engineer.
GLOBAL THEME: {domain}  <-- Injected here

TASK: Extract learning concepts from the text below.
Constraints:
1. Ignore generic terms not related to {domain}.
2. For each concept, determine Bloom's Taxonomy level.

INPUT TEXT:
{chunk_text}</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Relationship Extraction</span>
                        <span class="method-code">_extract_relationships_from_chunk()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">X√°c ƒë·ªãnh c·∫°nh n·ªëi v√† t·ª´ kh√≥a c·∫°nh (Edge Keywords) theo nguy√™n l√Ω LightRAG.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                Concepts + Chunk
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                LLM Reasoning (Gemini 1.5)
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Edges (PREREQUISITE, RELATED...)
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: LightRAG Edge Prompt</summary>
                        <div class="dive-content">
                            <pre><code># actual implementation from backend/prompts.py
Identify relationships between these concepts:
{concept_list}

For each relationship, specify:
1. source: Source concept_id
2. target: Target concept_id
3. relationship_type: [REQUIRES, IS_PREREQUISITE_OF, ...]
4. weight: 0.0-1.0
5. dependency: STRONG, MODERATE, WEAK
6. keywords: **CRITICAL** - High-level themes summarizing the nature of the relationship (e.g., "Data Integrity").
7. summary: A concise sentence explaining why they are related.

Return ONLY valid JSON array.</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
            <div class="phase-section">
                <h2>Phase 3: Entity Resolution</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">3-Way Resolution Algorithm</span>
                        <span class="method-code">_entity_resolution()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">T√≠nh ƒëi·ªÉm tr√πng l·∫∑p d·ª±a tr√™n c√¥ng th·ª©c c√≥ tr·ªçng s·ªë.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                Candidate Pairs
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Weighted Similarity Aggregation
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Merge Decision (Boolean)
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: Similarity Formula</summary>
                        <div class="dive-content">
                            <pre><code># 3-Way Similarity Calculation (backend/utils/entity_resolver.py)
Score = (0.60 * S_semantic) + (0.30 * S_structural) + (0.10 * S_contextual)

Where:
- S_semantic: Cosine similarity of Embeddings ("Name | Context | Desc | Tags")
- S_structural: Jaccard similarity of Prerequisites maps
- S_contextual: Jaccard similarity of Tags (semantic_tags)

threshold = 0.85 (Configured in Agent)
IF Score > threshold:
    Execute Merge(Node A, Node B)
    # Conflict Resolution: Weighted Average for attributes</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
        
        <div class="complexity-card">
            <h2>Complexity & Performance Analysis</h2>
            <div class="complexity-grid">
                
            <div class="metric">
                <div class="metric-val">O(N) + O(C√ó3)</div>
                <div class="metric-label">Time (blocks)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">~15s</div>
                <div class="metric-label">Latency (20k) (seconds)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">5</div>
                <div class="metric-label">Concurrency (threads)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">~150</div>
                <div class="metric-label">Memory (MB)</div>
            </div>
        
            </div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;">
                <h3>Performance Bottleneck</h3>
                <p>LLM Latency per chunk (Phase 2). Mitigated by Semaphore=5 parallel execution.</p>
            </div>
        </div>

        <div style="text-align: center; color: #94a3b8; margin-top: 60px; font-size: 0.9em;">
             Thesis Defense System ‚Ä¢ Generated by Antigravity ‚Ä¢ 2026-01-15 21:02
        </div>
    </div>

    <!-- Detail Panel -->
    <div id="backdrop" class="backdrop" onclick="closeDetails()"></div>
    <div id="detail-panel" class="detail-panel">
        <div class="panel-header">
            <h2 id="panel-title">Component Details</h2>
            <button onclick="closeDetails()" style="background:none; border:none; color:white; font-size:1.5em; cursor:pointer;">√ó</button>
        </div>
        <div class="panel-body">
            <div id="panel-desc" class="panel-section"></div>
            
            <div class="panel-section" style="display:none; background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 25px;">
                <div class="panel-label" style="color: var(--accent);">Internal Logic</div>
                <div id="panel-logic" style="color: #334155; font-size: 0.95em;"></div>
            </div>

            <div class="panel-label">Technical Specs</div>
            <pre id="panel-specs" class="panel-code"></pre>
            
            <div class="panel-label">Source Reference</div>
            <div id="panel-source" style="font-family: 'Fira Code', monospace; color: var(--accent); font-size: 0.9em;"></div>
        </div>
    </div>

    <script>
        const NODE_DETAILS = {"Doc": {"title": "Document Stream", "desc": "Input handler for PDF/Image/Text files. Converts binary streams to normalized text using `PyMuPDF` or `GeminiVision`.", "logic": "1. Validate MIME type & Magic Numbers.\n2. If PDF, use PyMuPDF to extract text layer.\n3. If Image, use Gemini Vision to OCR.\n4. Normalize to UTF-8 stream.", "specs": "Max Size: 50MB\nFormats: .pdf, .docx, .md, .png\nValidation: Magic Numbers check", "source": "backend/api/router.py"}, "Registry": {"title": "Document Registry", "desc": "Idempotency layer to prevent re-processing identical documents. Uses SHA-256 hash of file content.", "logic": "1. Calculate SHA-256 of raw file bytes.\n2. Check Redis Set `doc_hash:{hash}`.\n3. If exists -> Reject/Return Cache.\n4. If new -> Add to Set & Proceed.", "specs": "Storage: Redis Set\nKey: `doc_hash:{sha256}`\nTTL: Permanent", "source": "backend/models/document_registry.py"}, "Chunk": {"title": "SemanticChunker", "desc": "Intelligent splitter that preserves hierarchical context (MultiDocFusion). Does NOT use fixed character windows.", "logic": "1. Split by Paragraphs (\\n\\n).\n2. Build Tree Structure based on Headers (#, ##).\n3. Traverse Tree (DFS) to group related sections.\n4. Merge until token limit (4000) reached.", "specs": "Algorithm: MultiDocFusion\nMax Token: 10,000\nOverlap: Context-based (not fixed)", "source": "backend/utils/semantic_chunker.py"}, "LLM": {"title": "Gemini 1.5 Pro/Flash", "desc": "Multimodal LLM used for extraction. Flash is used for high-volume extraction, Pro for complex reasoning.", "logic": "1. Construct Prompt with 'Global Theme'.\n2. Call API with Temperature=0.0.\n3. Parse JSON output.\n4. Retry on JSONDecodeError (Exponential Backoff).", "specs": "Model: `gemini-1.5-flash-latest`\nTemp: 0.0 (Deterministic)\nRetries: 3 (Exponential Backoff)", "source": "backend/core/llm_provider.py"}, "Concepts": {"title": "Concept Extractor", "desc": "Extracts entities using Pydantic validation. Enforces 'Global Theme' constraint.", "logic": "1. Filter terms NOT related to Domain (e.g. 'SQL').\n2. Classify Bloom's Level (Remember -> Create).\n3. Validate against `ConceptNode` schema.", "specs": "Output: `List[ConceptNode]`\nStrict JSON Mode: True\nField: `bloom_level` (1-6)", "source": "backend/agents/knowledge_extraction_agent.py"}, "Rels": {"title": "Relationship Extractor", "desc": "Identifies connections between concepts. Generates 'Edge Keywords' for LightRAG indexing.", "logic": "1. Analyze co-occurrence in chunk.\n2. Determine Relationship Type (Prerequisite vs Related).\n3. Extract 3-5 keywords summarizing the edge.\n4. Assign Weight (0.0-1.0).", "specs": "Output: `List[Relationship]`\nTypes: [REQUIRES, RELATED_TO...]\nEdge Attr: `keywords`", "source": "backend/prompts.py"}, "Meta": {"title": "Metadata Extractor", "desc": "Classifies document metadata (Domain, Difficulty, Target Audience) for filtering.", "logic": "1. Analyze first 1000 tokens.\n2. Extract 'Target Audience' (Beginner/Adv).\n3. Identify Top-5 semantic topics.", "specs": "Fields: [domain, difficulty, audience]\nAuto-Tagging: Top-5 Topics", "source": "backend/agents/knowledge_extraction_agent.py"}, "ER": {"title": "Entity Resolver", "desc": "Merges duplicate concepts (e.g., 'Loop' vs 'Loops') using 3-Way Similarity.", "logic": "1. Semantic Sim (Cosine of Embeddings).\n2. Structural Sim (Jaccard of Neighbors).\n3. Lexical Sim (Levenshtein).\n4. Weighted Sum > 0.85 -> Merge.", "specs": "Threshold: 0.85\nWeights: Semantic(0.6) + Struct(0.3) + Lexical(0.1)\nVector: 768-dim (Gemini)", "source": "backend/utils/entity_resolver.py"}, "UniqueNodes": {"title": "Merged Entity Set", "desc": "Final clean set of nodes after resolution. Represents the canonical knowledge.", "logic": "1. Deduplicate by Name (Case-insensitive).\n2. Merge Attributes (Description, Tags).\n3. Re-link Relationships to Canonical ID.", "specs": "Structure: `Dict[ConceptID, ConceptNode]`\nConstraint: Unique IDs", "source": "Memory (Runtime)"}, "Neo4j": {"title": "Neo4j Graph DB", "desc": "Persistent storage for the Knowledge Graph. Stores Nodes and relationships with vector index.", "logic": "1. Batch Upsert (UNWIND logic).\n2. Update Vector Index.\n3. Create constraints (Unique IDs).", "specs": "Index: Vector (Cosine)\nConstraints: Unique(ConceptID)\nBatch Size: 500 nodes", "source": "backend/utils/neo4j_batch_upsert.py"}};

        function showDetails(nodeId) {
            const data = NODE_DETAILS[nodeId];
            if (!data) return;

            document.getElementById('panel-title').innerText = data.title;
            document.getElementById('panel-desc').innerHTML = data.desc;
            
            // Logic Section (New)
            const logicEl = document.getElementById('panel-logic');
            if (data.logic) {
                logicEl.innerText = data.logic;
                logicEl.parentElement.style.display = 'block';
            } else {
                logicEl.parentElement.style.display = 'none';
            }

            document.getElementById('panel-specs').innerText = data.specs || "No specific configuration.";
            document.getElementById('panel-source').innerText = data.source || "System Component";
            
            document.getElementById('backdrop').classList.add('active');
            document.getElementById('detail-panel').classList.add('active');
        }

        function closeDetails() {
            document.getElementById('backdrop').classList.remove('active');
            document.getElementById('detail-panel').classList.remove('active');
        }

        // Auto-attach clicks after Mermaid renders
        // Note: We use the native mermaid click directive in the graph definition
    </script>
</body>
</html>
