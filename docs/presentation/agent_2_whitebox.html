
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Agent 2: Profiler - Deep Dive Whitebox</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0f172a;     /* Slate 900 */
            --accent: #3b82f6;      /* Blue 500 */
            --success: #10b981;     /* Emerald 500 */
            --warning: #f59e0b;     /* Amber 500 */
            --danger: #ef4444;      /* Red 500 */
            --bg: #f8fafc;
            --code-bg: #1e293b;
            --code-text: #e2e8f0;
        }
        
        body { font-family: 'Inter', sans-serif; padding: 40px; background: var(--bg); color: #334155; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header */
        .header { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 40px; border-top: 6px solid var(--accent); }
        .header h1 { margin: 0; color: var(--primary); font-size: 2.8em; letter-spacing: -0.02em; }
        .role-title { font-size: 1.4em; color: #64748b; margin-top: 10px; font-weight: 500; }
        
        .badges { margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap; }
        .badge { padding: 6px 14px; border-radius: 24px; font-weight: 600; font-size: 0.9em; }
        .badge-science { background: #eff6ff; color: var(--accent); border: 1px solid #bfdbfe; }
        .badge-tech { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; }
        
        /* Diagram */
        .card { background: white; padding: 30px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .key-insight { 
            margin-top: 20px; padding: 20px; 
            border-left: 4px solid var(--warning); 
            background: #fffbeb; color: #92400e;
            font-size: 1.1em;
        }
        
        /* Phase Steps */
        .phase-section h2 { color: var(--primary); border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 0; }
        
        .step { margin-bottom: 40px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
        .step-header { 
            padding: 15px 25px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .step-title { font-weight: 700; color: var(--primary); font-size: 1.1em; }
        .method-code { font-family: 'Fira Code', monospace; background: #e2e8f0; color: #475569; padding: 4px 8px; border-radius: 6px; font-size: 0.9em; }
        
        .step-body { padding: 25px; }
        .step-desc { font-size: 1.05em; margin-bottom: 20px; color: #1e293b; }
        
        /* IO Grid */
        .io-grid { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 20px; margin-bottom: 20px; }
        .io-box { padding: 15px; border-radius: 8px; font-size: 0.95em; }
        .io-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.05em; }
        
        .io-input { background: #f1f5f9; border: 1px solid #cbd5e1; }
        .io-mech { background: #eef2ff; border: 1px solid #c7d2fe; }
        .io-output { background: #f0fdf4; border: 1px solid #bbf7d0; }
        
        /* Deep Dive collapsible */
        details.deep-dive { margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 8px; }
        details.deep-dive summary { 
            padding: 12px 20px; background: #f8fafc; cursor: pointer; font-weight: 600; color: var(--accent);
            list-style: none; display: flex; align-items: center; gap: 8px;
        }
        details.deep-dive summary::before { content: "‚öôÔ∏è"; }
        details.deep-dive[open] summary { border-bottom: 1px solid #e2e8f0; }
        
        .dive-content { padding: 20px; background: #ffffff; }
        
        pre { margin: 0; background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; color: var(--code-text); font-size: 0.9em; }
        
        .formula-box { 
            background: #fff; border-left: 4px solid var(--secondary); padding: 15px; margin: 15px 0; font-family: 'Times New Roman', serif; font-style: italic; font-size: 1.1em; 
        }

        /* Complexity Card */
        .complexity-card { background: #1e293b; color: white; padding: 30px; border-radius: 16px; margin-top: 40px; }
        .complexity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-top: 20px; }
        .metric { text-align: center; }
        .metric-val { font-size: 2em; font-weight: 700; color: var(--accent); }
        .metric-label { font-size: 0.9em; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Detail Panel */
        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 90; }
        .backdrop.active { opacity: 1; pointer-events: all; }
        
        .detail-panel { 
            position: fixed; top: 0; right: -500px; width: 450px; height: 100%; 
            background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); 
            transition: right 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 100; overflow-y: auto;
        }
        .detail-panel.active { right: 0; }
        
        .panel-header { background: var(--primary); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { margin: 0; font-size: 1.3em; }
        
        .panel-body { padding: 25px; }
        .panel-section { margin-bottom: 25px; font-size: 1em; color: #475569; }
        .panel-label { text-transform: uppercase; font-size: 0.75em; font-weight: 700; color: #94a3b8; margin-bottom: 8px; letter-spacing: 0.05em; }
        .panel-code { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: 'Fira Code', monospace; font-size: 0.85em; color: var(--primary); white-space: pre-wrap; }

    </style>
</head>
<body>
    <div class="container">
        
        <div class="header">
            <div style="text-transform: uppercase; color: var(--accent); font-weight: 700; font-size: 0.9em; letter-spacing: 0.1em; margin-bottom: 10px;">Detailed Technical Specification</div>
            <h1>Agent 2: Profiler</h1>
            <div class="role-title">The State Manager (Qu·∫£n l√Ω tr·∫°ng th√°i)</div>
            
            <p style="font-size: 1.1em; max-width: 800px; margin-top: 20px;">Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ 'Cold Start' (ng∆∞·ªùi d√πng m·ªõi) v√† m√¥ h√¨nh h√≥a nƒÉng l·ª±c ng∆∞·ªùi h·ªçc th√†nh Vector to√°n h·ªçc ƒë·ªÉ c√°c Agent kh√°c s·ª≠ d·ª•ng.</p>
            
            <div class="badges">
                <span class="badge badge-science">Semantic LKT (Lee 2024)</span><span class="badge badge-science">VARK Model</span><span class="badge badge-science">Vector Space Model</span>
                <span class="badge badge-tech">PostgreSQL</span><span class="badge badge-tech">Redis</span><span class="badge badge-tech">Gemini Embeddings</span><span class="badge badge-tech">RedLock</span>
            </div>
        </div>

        <div class="card">
            <h2>Process Architecture</h2>
            <div class="mermaid">

sequenceDiagram
    participant User
    participant A2 as Agent 2
    participant Neo4j
    participant DB as Postgres
    participant Redis
    
    User->>A2: "Teach me SQL Joins"
    A2->>A2: Intent Parsing (Few-Shot)
    A2->>Neo4j: Hybrid Retrieval (Keyword+Vector)
    
    alt Cold Start
        A2->>User: Diagnostic Test (3 Questions)
        User-->>A2: Answers
        A2->>DB: Fetch Learner Profile
        A2->>A2: Zero-Shot LKT Inference (LLM)
    end
    
    A2->>A2: Vectorize Profile (10-dim Array)
    
    par Dual-Write
        A2->>DB: ACID Save (Source of Truth)
        A2->>Redis: Cache Component State
    end
    
    click User showDetails
    click A2 showDetails
    click Neo4j showDetails
    click DB showDetails
    click Redis showDetails
        
click User showDetails
click A2 showDetails
click Neo4j showDetails
click DB showDetails
click Redis showDetails
            </div>
            <div class="key-insight">
                <strong>üí° Core Deviation / Innovation:</strong> Thay th·∫ø Bayesian Knowledge Tracing (BKT) c≈© b·∫±ng Zero-Shot LKT d·ª±a tr√™n LLM, cho ph√©p suy lu·∫≠n tr·∫°ng th√°i mastery ngay c·∫£ khi ch∆∞a c√≥ l·ªãch s·ª≠ log.
            </div>
        </div>

        
            <div class="phase-section">
                <h2>Phase 1: Cold Start Resolution</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">Zero-Shot LKT Inference</span>
                        <span class="method-code">_predict_mastery_lkt()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">Suy lu·∫≠n m·ª©c ƒë·ªô th√†nh th·∫°o mastery ch·ªâ d·ª±a tr√™n b√†i test ng·∫Øn, kh√¥ng c·∫ßn train model BKT.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                DiagnosticQA + Concept Desc
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                LLM Reasoning (Lee 2024)
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Mastery Probability (0.0 - 1.0)
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: LKT Prompt Logic</summary>
                        <div class="dive-content">
                            <pre><code>Human: The student answered 'Inner Join' to question 1 (Correct).
Answered 'Left Join' to question 2 (Incorrect - Conceptual Error).
Concept: SQL Joins.

Task: Estimate mastery probability p(m).
Reasoning:
1. Student identified basic syntax correctly.
2. Failed to distinguish Left/Inner logic.
3. Conclusion: Partial mastery, high procedural, low conceptual.

Output: 0.45</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
            <div class="phase-section">
                <h2>Phase 2: Profile Vectorization</h2>
                
                <div class="step">
                    <div class="step-header">
                        <span class="step-title">10-Dimensional Embedding</span>
                        <span class="method-code">_vectorize_profile()</span>
                    </div>
                    <div class="step-body">
                        <p class="step-desc">Bi·∫øn ƒë·ªïi to√†n b·ªô h·ªì s∆° phi c·∫•u tr√∫c th√†nh vector c·ªë ƒë·ªãnh ƒë·ªÉ Agent 3 (Planner) s·ª≠ d·ª•ng.</p>
                        
                        <div class="io-grid">
                            <div class="io-box io-input">
                                <div class="io-label">Input</div>
                                JSON Profile
                            </div>
                            <div class="io-box io-mech">
                                <div class="io-label">Mechanism</div>
                                Normalization & One-Hot
                            </div>
                            <div class="io-box io-output">
                                <div class="io-label">Output</div>
                                Float32 Array [10]
                            </div>
                        </div>
                        
                        
                    <details class="deep-dive">
                        <summary>Deep Dive: Vector Components</summary>
                        <div class="dive-content">
                            <pre><code>Vector Structure V = [v1, v2, ..., v10]

v1: Current Global Mastery (0-1)
v2: Velocity (Concepts/Hour)
v3: Visual Preference (VARK)
v4: Auditory Preference (VARK)
v5: Textual Preference (VARK)
v6: Kinesthetic Preference (VARK)
v7: Time Availability (Normalized 0-1)
v8: Goal Difficulty
v9: Frustration Level (Recent Failures)
v10: Bloom Capability</code></pre>
                        </div>
                    </details>
                    
                    </div>
                </div>
                
            </div>
            
        
        <div class="complexity-card">
            <h2>Complexity & Performance Analysis</h2>
            <div class="complexity-grid">
                
            <div class="metric">
                <div class="metric-val">O(1)</div>
                <div class="metric-label">Time (blocks)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">~200ms</div>
                <div class="metric-label">Latency (ms)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">20</div>
                <div class="metric-label">Storage (KB/user)</div>
            </div>
        
            <div class="metric">
                <div class="metric-val">10</div>
                <div class="metric-label">Vector Dim (d)</div>
            </div>
        
            </div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155;">
                <h3>Performance Bottleneck</h3>
                <p>I/O bound (DB writes). Mitigated by Async Dual-Write.</p>
            </div>
        </div>

        <div style="text-align: center; color: #94a3b8; margin-top: 60px; font-size: 0.9em;">
             Thesis Defense System ‚Ä¢ Generated by Antigravity ‚Ä¢ 2026-01-14 18:01
        </div>
    </div>

    <!-- Detail Panel -->
    <div id="backdrop" class="backdrop" onclick="closeDetails()"></div>
    <div id="detail-panel" class="detail-panel">
        <div class="panel-header">
            <h2 id="panel-title">Component Details</h2>
            <button onclick="closeDetails()" style="background:none; border:none; color:white; font-size:1.5em; cursor:pointer;">√ó</button>
        </div>
        <div class="panel-body">
            <div id="panel-desc" class="panel-section"></div>
            
            <div class="panel-section" style="display:none; background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 25px;">
                <div class="panel-label" style="color: var(--accent);">Internal Logic</div>
                <div id="panel-logic" style="color: #334155; font-size: 0.95em;"></div>
            </div>

            <div class="panel-label">Technical Specs</div>
            <pre id="panel-specs" class="panel-code"></pre>
            
            <div class="panel-label">Source Reference</div>
            <div id="panel-source" style="font-family: 'Fira Code', monospace; color: var(--accent); font-size: 0.9em;"></div>
        </div>
    </div>

    <script>
        const NODE_DETAILS = {"User": {"title": "Learner Actor", "desc": "End-user interacting via Chat Interface. Goals are parsed by Intent Extraction.", "logic": "1. Sends message ('Teach me SQL').\n2. Authenticated via JWT.\n3. Receives Streamed Response.", "specs": "Input: Natural Language\nAuth: Bearer Token", "source": "Frontend/Client"}, "A2": {"title": "ProfilerAgent", "desc": "Orchestrates Cold Start diagnosis, State updates, and Profile Vectorization.", "logic": "1. Check Redis for Session.\n2. If New -> Trigger Cold Start (3-Q Diagnostic).\n3. If Returning -> Update Dynamic State (Velocity, Mood).\n4. Vectorize Profile.", "specs": "Model: Zero-Shot LKT (Gemini)\nVector Dim: 10\nTTL: 3600s", "source": "backend/agents/profiler_agent.py"}, "Neo4j": {"title": "Neo4j Graph Store", "desc": "Hybrid Retriever (Vector + Graph) for Diagnostic Concepts.", "logic": "1. Embed User Goal (Vector).\n2. Graph Traversal (Centrality).\n3. Return weighted concepts for Diagnosis.", "specs": "Index: PropertyGraphIndex\nRerank: Centrality", "source": "backend/agents/profiler_agent.py"}, "DB": {"title": "LearnerProfile (Postgres)", "desc": "Comprehensive 17-dimension profile (Static, Dynamic, Episodic).", "logic": "1. ACID Transaction for Profile Save.\n2. Stores History (Sessions, Errors).\n3. Source of Truth for Rehydration.", "specs": "Schema: LearnerProfile\nDims: 17 (Thesis Tab 3.8)", "source": "backend/models/schemas.py"}, "Redis": {"title": "Redis Cache", "desc": "High-speed state cache for Session and Profile data.", "logic": "1. Store `profile:{id}` as JSON.\n2. Use RedLock for distributed updates.\n3. Expire after 1 hour (Slide on Activity).", "specs": "Key: `profile:{id}`\nTTL: 3600s\nLock: RedLock", "source": "backend/database/redis_client.py"}};

        function showDetails(nodeId) {
            const data = NODE_DETAILS[nodeId];
            if (!data) return;

            document.getElementById('panel-title').innerText = data.title;
            document.getElementById('panel-desc').innerHTML = data.desc;
            
            // Logic Section (New)
            const logicEl = document.getElementById('panel-logic');
            if (data.logic) {
                logicEl.innerText = data.logic;
                logicEl.parentElement.style.display = 'block';
            } else {
                logicEl.parentElement.style.display = 'none';
            }

            document.getElementById('panel-specs').innerText = data.specs || "No specific configuration.";
            document.getElementById('panel-source').innerText = data.source || "System Component";
            
            document.getElementById('backdrop').classList.add('active');
            document.getElementById('detail-panel').classList.add('active');
        }

        function closeDetails() {
            document.getElementById('backdrop').classList.remove('active');
            document.getElementById('detail-panel').classList.remove('active');
        }

        // Auto-attach clicks after Mermaid renders
        // Note: We use the native mermaid click directive in the graph definition
    </script>
</body>
</html>
